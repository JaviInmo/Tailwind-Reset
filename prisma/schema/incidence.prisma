model Incident {
  id                  Int                @id @default(autoincrement())
  date                DateTime
  provinceId          String
  province            Province           @relation(fields: [provinceId], references: [id])
  municipalityId      String
  municipality        Municipality       @relation(fields: [municipalityId], references: [id])
  variableId          Int
  variable            Variable           @relation(fields: [variableId], references: [id])
  categoryId          Int
  category            Category           @relation(fields: [categoryId], references: [id])
  subcategoryId       Int?
  subcategory         Subcategory?       @relation(fields: [subcategoryId], references: [id])
  secondSubcategoryId Int?
  secondSubcategory   SecondSubcategory? @relation(fields: [secondSubcategoryId], references: [id])
  numberOfPeople      Int?
  description         String
  title               String
  unitMeasures        IncidentUnitMeasure[]
  items               IncidentItem[]

  @@map("incidencias")
}

model IncidentUnitMeasure {
  id            Int         @id @default(autoincrement())
  incidentId    Int
  incident      Incident    @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  unitMeasureId Int
  unitMeasure   UnitMeasure @relation(fields: [unitMeasureId], references: [id])
  @@unique([incidentId, unitMeasureId])
  @@map("incident_unit_measures")
}

model IncidentItem {
  id           Int          @id @default(autoincrement())
  itemId       Int
  item         Item         @relation(fields: [itemId], references: [id])
  incidentId   Int
  incident     Incident     @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  quantityUsed Float?

  unitMeasureId Int?
  unitMeasure   UnitMeasure? @relation(fields: [unitMeasureId], references: [id])

  @@unique([incidentId, itemId])
  @@map("incident_items")
}

model Item {
  id                  Int                @id @default(autoincrement())
  productName         String
  variableId          Int
  variable            Variable           @relation(fields: [variableId], references: [id])
  categoryId          Int
  category            Category           @relation(fields: [categoryId], references: [id])
  subcategoryId       Int
  subcategory         Subcategory        @relation(fields: [subcategoryId], references: [id])
  secondSubcategoryId Int?
  secondSubcategory   SecondSubcategory? @relation(fields: [secondSubcategoryId], references: [id])

  incidentItems       IncidentItem[]
  availableUnitMeasures ItemUnitMeasure[] // Nueva relación de muchos a muchos

  @@unique([productName, variableId, categoryId, subcategoryId, secondSubcategoryId])
  @@map("items")
}

// Nueva tabla intermedia para la relación muchos a muchos
model ItemUnitMeasure {
  id            Int         @id @default(autoincrement())
  itemId        Int
  item          Item        @relation(fields: [itemId], references: [id], onDelete: Cascade)
  unitMeasureId Int
  unitMeasure   UnitMeasure @relation(fields: [unitMeasureId], references: [id])

  @@unique([itemId, unitMeasureId])
  @@map("item_unit_measures")
}

model Variable {
  id         Int        @id @default(autoincrement())
  name       String
  categories Category[]
  incidents  Incident[]
  items      Item[]
  @@map("variables")
}

model Category {
  id            Int           @id @default(autoincrement())
  name          String
  variableId    Int
  variable      Variable      @relation(fields: [variableId], references: [id])
  subcategories Subcategory[]
  incidents     Incident[]
  items         Item[]
  @@map("categorias")
}

model Subcategory {
  id                  Int                 @id @default(autoincrement())
  name                String
  categoryId          Int
  category            Category            @relation(fields: [categoryId], references: [id])
  secondSubcategories SecondSubcategory[]
  incidents           Incident[]
  items               Item[]
  @@map("subcategorias")
}

model SecondSubcategory {
  id            Int         @id @default(autoincrement())
  name          String
  subcategoryId Int
  subcategory   Subcategory @relation(fields: [subcategoryId], references: [id])
  incidents     Incident[]
  items         Item[]
  @@map("secondsubcategorias")
}

model UnitMeasure {
  id                   Int                   @id @default(autoincrement())
  name                 String                @unique
  incidentItems        IncidentItem[]
  incidentUnitMeasures IncidentUnitMeasure[]
  items                ItemUnitMeasure[] // Actualizada la relación para la nueva tabla intermedia
  @@map("unidades_medida")
}

model Province {
  id             String         @id @default(cuid())
  name           String         @unique
  municipalities Municipality[]
  incidents      Incident[]
  contacts       Contact[]
  @@map("provincias")
}

model Municipality {
  id         String     @id @default(cuid())
  name       String
  provinceId String
  province   Province   @relation(fields: [provinceId], references: [id])
  incidents  Incident[]
  contacts   Contact[]
  @@map("municipios")
}


